---
// @/pages/dash/auth/callback.astro
import { discordAuth } from '@/lib/discord-auth'
import { setAuthCookies } from '@/lib/cookie-utils'

export const prerender = false

if (Astro.request.method === 'GET') {
  const url = new URL(Astro.request.url)
  const code = url.searchParams.get('code')
  const error = url.searchParams.get('error')

  if (error) {
    console.error('OAuth error:', error)
    return Astro.redirect('/', 302)
  }

  if (!code) {
    console.error('No code provided')
    return Astro.redirect('/', 302)
  }

  try {
    const tokenData = await discordAuth.exchangeCode(code)
    const userData = await discordAuth.getUserInfo(tokenData.access_token)
    
    // Set all auth cookies at once
    setAuthCookies(Astro.cookies, tokenData, userData)

    return Astro.redirect('/dash', 302)
  } catch (err) {
    console.error('Auth error:', err)
    return Astro.redirect('/', 302)
  }
}
---
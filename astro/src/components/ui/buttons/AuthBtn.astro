---
// @/components/ui/buttons/AuthBtn.astro
import { discordAuth } from '@/lib/discord-auth'
import { setAuthCookies, clearAuthCookies, COOKIE_NAMES } from '@/lib/cookie-utils'
import LoginBtn from './LoginBtn.astro'
import DashboardBtn from './DashboardBtn.astro'

const accessToken = Astro.cookies.get(COOKIE_NAMES.ACCESS_TOKEN)?.value
const refreshToken = Astro.cookies.get(COOKIE_NAMES.REFRESH_TOKEN)?.value

let isAuthenticated = false

if (accessToken) {
  try {
    // Check if the access token is still valid
    isAuthenticated = await discordAuth.validateToken(accessToken)
    
    if (!isAuthenticated && refreshToken) {
      // Try to refresh the token
      const newTokenData = await discordAuth.refreshToken(refreshToken)
      const userData = await discordAuth.getUserInfo(newTokenData.access_token)
      
      // Update all cookies at once
      setAuthCookies(Astro.cookies, newTokenData, userData)
      isAuthenticated = true
    }
  } catch (error) {
    // If any error occurs, clear all cookies
    clearAuthCookies(Astro.cookies)
  }
}
---

{isAuthenticated ? <DashboardBtn /> : <LoginBtn />}